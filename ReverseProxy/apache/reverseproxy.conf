<VirtualHost *:80>
        ServerName reverseproxy.l
        DocumentRoot /var/www/html

        # Reverse Proxy requests to correct VM
        ProxyRequests On
        ProxyPreserveHost on

        # Rewrite websocket requests to make Jupyter work
        RewriteEngine on

        # Authentication Header
        RequestHeader set X-Authenticated-User expr=%{REMOTE_USER}
        RequestHeader set X-Authenticated-Name expr=%{REMOTE_USER}
        # For SSL
        #RequestHeader set X-Authenticated-User expr=%{REMOTE_USER}s

        <Location />
            AuthType Basic
            AuthName "Restricted"
            # (Following line optional)
            AuthBasicProvider file
            AuthUserFile "/etc/apache2/passwords"
            Require valid-user
        </Location>

        RedirectMatch 301 /hub(\d+)$ /hub$1/
        <LocationMatch "^/hub(\d+)/(.*)">
            RewriteCond %{HTTP:Connection} Upgrade [NC]
            RewriteCond %{HTTP:Upgrade} websocket [NC]
            RewriteRule /hub(\d+)/(.*) ws://172.21.11.$1:8000/hub$1/$2 [NE,P,L]

            ProxyPassMatch http://172.21.11.$1:8000/hub$1/$2
            ProxyPassReverse http://172.21.11.$1:8000/hub$1/$2
        </LocationMatch>

        RedirectMatch 301 /ep(\d+)$ /ep$1/
        <LocationMatch "^/ep(\d+)/(.*)">
            ProxyPassMatch http://172.21.11.$1:9001/$2
            ProxyPassReverse  http://172.21.11.$1:9001/$2
        </LocationMatch>
        <LocationMatch "^/ep(.+)/socket.io">
            RewriteCond %{QUERY_STRING} transport=websocket    [NC]
            RewriteRule /ep(\d+)/(.*) ws://172.21.11.$1:9001/socket.io/$2 [P,L]
        </LocationMatch>
</VirtualHost>
